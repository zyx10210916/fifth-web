<template>
  <div class="left">
    <!-- 法人单位数量卡片 -->
    <div class="item-box corporate-box" cid="ItemBox">
      <div class="head">
        法人单位数量
        <div class="right"></div>
      </div>
      <div class="content">
        <svg 
          data-v-9dada9bc 
          data-v-e868fad4 
          xmlns="http://www.w3.org/2000/svg"  
          xmlns:xlink="http://www.w3.org/1999/xlink"  
          width="289" 
          height="80" 
          viewBox="40 26 320 80" 
          fill="none" 
          data-v-40a065a8 
          style="width: calc(100% - 0.2rem); height: auto; margin: 0px 0.1rem;" 
          cid="Item1"
        > 
          <g data-v-9dada9bc filter="url(#filter_54_12010)">
            <g data-v-9dada9bc clip-path="url(#clip-path-54_12010)">
              <rect data-v-9dada9bc x="28" y="8.99658203125" width="338.00006103515625" height="108" rx="20" fill="url(#linear_fill_54_12001_0)" style="mix-blend-mode: normal;"></rect>
              <g data-v-9dada9bc mask="url(#mask-54_12002)" opacity="0.1">
                <path data-v-9dada9bc d="M298.689 -39L177 173L371 173L365.384 -39L298.689 -39Z" fill="url(#linear_fill_54_12003)" style="mix-blend-mode: normal;"></path>
              </g>
              <g data-v-9dada9bc mask="url(#mask-54_12002)">
                <path data-v-9dada9bc d="M324 43C322.9 43 322 43.9 322 45C322 46.1 322.9 47 324 47C325.1 47 326 46.1 326 45C326 43.9 325.1 43 324 43ZM336 43C334.9 43 334 43.9 334 45C334 46.1 334.9 47 336 47C337.1 47 338 46.1 338 45C338 43.9 337.1 43 336 43ZM330 43C328.9 43 328 43.9 328 45C328 46.1 328.9 47 330 47C331.1 47 332 46.1 332 45C332 43.9 331.1 43 330 43Z" fill="#FFFFFF" style="mix-blend-mode: normal;"></path>
              </g>
              <g data-v-9dada9bc mask="url(#mask-54_12002)">
                <path data-v-9dada9bc fill="#E9EDF7" d="M67.272 45.72Q67.068 46.128 66.81 46.596Q66.552 47.064 66.27 47.52Q65.988 47.976 65.718 48.378Q65.448 48.78 65.232 49.056Q65.316 49.056 65.556 49.038Q65.796 49.02 66.132 48.996Q66.468 48.972 66.864 48.948Q67.26 48.924 67.662 48.9Q68.064 48.876 68.43 48.852Q68.796 48.828 69.072 48.816Q68.76 48.264 68.436 47.772Q68.112 47.28 67.872 46.944L68.592 46.452Q68.832 46.764 69.144 47.232Q69.456 47.7 69.774 48.204Q70.092 48.708 70.374 49.206Q70.656 49.704 70.836 50.064L70.08 50.736Q69.984 50.496 69.852 50.226Q69.72 49.956 69.552 49.656Q69.192 49.68 68.592 49.722Q67.992 49.764 67.326 49.806Q66.66 49.848 66.03 49.902Q65.4 49.956 64.98 49.992Q64.716 50.016 64.512 50.046Q64.308 50.076 63.996 50.136L63.732 49.212Q63.996 49.116 64.128 49.032Q64.26 48.948 64.38 48.804Q64.548 48.6 64.782 48.252Q65.016 47.904 65.274 47.478Q65.532 47.052 65.79 46.596Q66.048 46.14 66.264 45.72L63.516 45.72L63.516 44.844L66.732 44.844L66.732 42.564L64.344 42.564L64.344 41.676L66.732 41.676L66.732 39.756L67.668 39.792L67.668 41.676L70.548 41.676L70.548 42.564L67.668 42.564L67.668 44.844L71.208 44.844L71.208 45.72L67.272 45.72ZM63.516 42.504Q63.324 42.288 63.042 42.042Q62.76 41.796 62.448 41.562Q62.136 41.328 61.842 41.124Q61.548 40.92 61.332 40.788L61.812 40.092Q62.028 40.212 62.322 40.41Q62.616 40.608 62.928 40.836Q63.24 41.064 63.528 41.286Q63.816 41.508 64.008 41.676L63.516 42.504ZM61.008 42.66Q61.224 42.804 61.548 43.02Q61.872 43.236 62.202 43.482Q62.532 43.728 62.838 43.968Q63.144 44.208 63.348 44.388L62.832 45.252Q62.64 45.036 62.34 44.766Q62.04 44.496 61.71 44.238Q61.38 43.98 61.062 43.752Q60.744 43.524 60.516 43.38L61.008 42.66ZM62.784 46.272L63.216 46.44Q63.108 46.836 62.916 47.394Q62.724 47.952 62.49 48.528Q62.256 49.104 62.022 49.644Q61.788 50.184 61.608 50.544L60.672 50.22Q60.888 49.86 61.14 49.326Q61.392 48.792 61.638 48.21Q61.884 47.628 62.088 47.07Q62.292 46.512 62.4 46.116L62.784 46.272ZM77.832 41.7Q77.952 42.996 78.318 44.112Q78.684 45.228 79.296 46.212Q79.908 47.196 80.754 48.066Q81.6 48.936 82.668 49.728L81.996 50.544Q80.292 49.164 79.152 47.604Q78.012 46.044 77.472 44.208Q77.004 45.996 75.888 47.52Q74.772 49.044 72.924 50.448L72.264 49.668Q73.524 48.756 74.406 47.826Q75.288 46.896 75.846 45.858Q76.404 44.82 76.662 43.632Q76.92 42.444 76.944 41.016Q76.944 40.944 76.95 40.77Q76.956 40.596 76.962 40.41Q76.968 40.224 76.968 40.068Q76.968 39.912 76.968 39.864L77.868 39.9Q77.868 39.948 77.868 40.14Q77.868 40.332 77.862 40.566Q77.856 40.8 77.85 41.028Q77.844 41.256 77.844 41.364Q77.844 41.46 77.844 41.538Q77.844 41.616 77.832 41.7ZM94.2 48.528L89.484 48.528L89.484 50.664L88.596 50.664L88.596 48.528L83.88 48.528L83.88 47.664L88.596 47.664L88.596 46.368L85.116 46.368L85.116 41.328L87.06 41.328Q86.88 40.968 86.652 40.596Q86.424 40.224 86.22 39.972L86.94 39.564Q87.06 39.708 87.204 39.906Q87.348 40.104 87.48 40.308Q87.612 40.512 87.738 40.716Q87.864 40.92 87.948 41.088L87.6 41.328L89.916 41.328Q90.084 41.124 90.252 40.884Q90.42 40.644 90.57 40.41Q90.72 40.176 90.852 39.954Q90.984 39.732 91.068 39.552L91.872 39.9Q91.728 40.176 91.482 40.572Q91.236 40.968 90.984 41.328L92.964 41.328L92.964 46.368L89.484 46.368L89.484 47.664L94.2 47.664L94.2 48.528ZM86.004 42.108L86.004 43.428L88.596 43.428L88.596 42.108L86.004 42.108ZM92.052 42.108L89.484 42.108L89.484 43.428L92.052 43.428L92.052 42.108ZM88.596 45.528L88.596 44.208L86.004 44.208L86.004 45.528L88.596 45.528ZM92.052 45.528L92.052 44.208L89.484 44.208L89.484 45.528L92.052 45.528ZM98.64 39.852Q98.412 40.56 98.178 41.19Q97.944 41.82 97.68 42.42L97.68 50.448L96.816 50.448L96.816 44.112Q96.276 45.036 95.616 45.888L94.908 45.252Q95.796 44.052 96.516 42.648Q97.236 41.244 97.692 39.696L98.64 39.852ZM105.696 42.552L98.688 42.552L98.688 41.7L101.868 41.7Q101.808 41.484 101.718 41.226Q101.628 40.968 101.532 40.722Q101.436 40.476 101.352 40.266Q101.268 40.056 101.22 39.948L102.06 39.708Q102.12 39.84 102.228 40.098Q102.336 40.356 102.444 40.656Q102.552 40.956 102.648 41.238Q102.744 41.52 102.804 41.7L105.696 41.7L105.696 42.552ZM105.912 49.068L105.912 49.92L98.352 49.92L98.352 49.068L102.12 49.068Q102.336 48.492 102.588 47.712Q102.84 46.932 103.074 46.11Q103.308 45.288 103.506 44.502Q103.704 43.716 103.812 43.14L104.76 43.332Q104.64 43.884 104.442 44.622Q104.244 45.36 104.01 46.146Q103.776 46.932 103.53 47.7Q103.284 48.468 103.056 49.068L105.912 49.068ZM100.716 48.312Q100.656 47.832 100.506 47.172Q100.356 46.512 100.164 45.828Q99.972 45.144 99.768 44.514Q99.564 43.884 99.384 43.452L100.224 43.212Q100.404 43.632 100.608 44.262Q100.812 44.892 101.004 45.564Q101.196 46.236 101.346 46.878Q101.496 47.52 101.556 47.976L100.716 48.312ZM115.308 47.592Q116.16 48.804 117.636 49.92L117.012 50.568Q116.328 50.016 115.788 49.47Q115.248 48.924 114.828 48.348Q114.384 48.936 113.784 49.488Q113.184 50.04 112.368 50.628L111.816 49.956Q112.68 49.38 113.292 48.81Q113.904 48.24 114.324 47.592Q113.856 46.776 113.574 45.9Q113.292 45.024 113.136 44.016Q113.04 44.184 112.938 44.358Q112.836 44.532 112.728 44.7L112.056 44.268Q112.392 43.8 112.686 43.23Q112.98 42.66 113.214 42.06Q113.448 41.46 113.616 40.866Q113.784 40.272 113.88 39.768L114.72 39.972Q114.624 40.404 114.498 40.83Q114.372 41.256 114.216 41.688L117.336 41.688L117.336 42.552L116.52 42.552Q116.448 43.368 116.352 44.076Q116.256 44.784 116.118 45.396Q115.98 46.008 115.782 46.554Q115.584 47.1 115.308 47.592ZM106.644 45.024Q107.472 44.616 108.12 44.106Q108.768 43.596 109.272 43.032L107.016 43.032L107.016 42.3L109.476 42.3L109.476 39.84L110.28 39.888L110.28 42.3L112.44 42.3L112.44 43.032L110.28 43.032L110.28 45.264L109.476 45.264L109.476 43.788Q109.02 44.316 108.426 44.79Q107.832 45.264 107.076 45.672L106.644 45.024ZM112.296 40.416Q112.212 40.608 112.092 40.836Q111.972 41.064 111.834 41.298Q111.696 41.532 111.552 41.748Q111.408 41.964 111.288 42.12L110.688 41.784Q110.796 41.64 110.928 41.436Q111.06 41.232 111.186 41.01Q111.312 40.788 111.426 40.554Q111.54 40.32 111.624 40.116L112.296 40.416ZM108.216 42.108Q108.156 41.916 108.066 41.682Q107.976 41.448 107.868 41.22Q107.76 40.992 107.652 40.788Q107.544 40.584 107.46 40.428L108.096 40.188Q108.18 40.32 108.288 40.524Q108.396 40.728 108.504 40.962Q108.612 41.196 108.708 41.436Q108.804 41.676 108.876 41.88L108.216 42.108ZM113.712 42.888Q113.844 44.028 114.096 44.97Q114.348 45.912 114.792 46.752Q115.188 45.888 115.392 44.874Q115.596 43.86 115.716 42.552L113.856 42.552L113.712 42.888ZM111.924 45.456Q111.576 45.036 111.186 44.622Q110.796 44.208 110.412 43.872L110.892 43.428Q111.204 43.668 111.624 44.082Q112.044 44.496 112.404 44.904L111.924 45.456ZM111.6 49.884Q111.264 49.68 110.904 49.494Q110.544 49.308 110.172 49.116Q109.656 49.5 108.93 49.848Q108.204 50.196 107.148 50.544L106.728 49.788Q107.628 49.524 108.27 49.266Q108.912 49.008 109.38 48.72Q108.456 48.276 107.592 47.952Q107.76 47.676 107.928 47.388Q108.096 47.1 108.252 46.812L106.86 46.812L106.86 46.092L108.612 46.092Q108.72 45.864 108.81 45.654Q108.9 45.444 108.972 45.252L109.74 45.504Q109.68 45.66 109.62 45.804Q109.56 45.948 109.5 46.092L111.996 46.092L111.996 46.776Q111.756 47.28 111.48 47.724Q111.204 48.168 110.808 48.564Q111.072 48.696 111.348 48.822Q111.624 48.948 111.924 49.092L111.6 49.884ZM108.684 47.664Q109.008 47.796 109.344 47.934Q109.68 48.072 110.052 48.24Q110.412 47.928 110.658 47.58Q110.904 47.232 111.108 46.812L109.152 46.812Q109.044 47.04 108.924 47.25Q108.804 47.46 108.684 47.664ZM127.704 42.9L119.772 42.9L119.772 40.128L127.704 40.128L127.704 42.9ZM120.684 40.716L120.684 41.244L126.804 41.244L126.804 40.716L120.684 40.716ZM126.804 42.324L126.804 41.784L120.684 41.784L120.684 42.324L126.804 42.324ZM129.072 43.464L129.072 44.1L118.404 44.1L118.404 43.464L129.072 43.464ZM124.176 49.656L128.82 49.656L128.82 50.292L118.656 50.292L118.656 49.656L123.312 49.656L123.312 48.96L119.472 48.96L119.472 48.324L123.312 48.324L123.312 47.628L119.76 47.628L119.76 44.724L127.704 44.724L127.704 47.628L124.176 47.628L124.176 48.324L128.004 48.324L128.004 48.96L124.176 48.96L124.176 49.656ZM120.66 45.3L120.66 45.888L123.312 45.888L123.312 45.3L120.66 45.3ZM126.804 45.3L124.176 45.3L124.176 45.888L126.804 45.888L126.804 45.3ZM123.312 47.04L123.312 46.452L120.66 46.452L120.66 47.04L123.312 47.04ZM126.804 47.04L126.804 46.452L124.176 46.452L124.176 47.04L126.804 47.04Z" style="mix-blend-mode: normal;"></path>
              </g>
              <g data-v-9dada9bc mask="url(#mask-54_12002)">
                <path data-v-9dada9bc stroke="rgba(255, 255, 255, 1)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" d="M279 77.2C279.702 80.8 282.5 87.5 289 87C295.5 86.5 296.279 70 307.657 70C319.036 70 319.036 89.0286 338 72.5714" style="mix-blend-mode: normal;"></path>
              </g>
            </g>
          </g>
          <defs data-v-9dada9bc>
            <clipPath data-v-9dada9bc id="clip-path-54_12010">
              <path data-v-9dada9bc d="M40 94L40 39C40 29.6112 47.6112 22 57 22L342 22C351.389 22 359 29.6112 359 39L359 94C359 103.389 351.389 111 342 111L57 111C47.6112 111 40 103.389 40 94Z" fill="white"></path>
            </clipPath>
            <linearGradient data-v-9dada9bc id="linear_fill_54_12001_0" x1="28" y1="8.99658203125" x2="366.00006103515625" y2="116.99658203125" gradientUnits="userSpaceOnUse">
              <stop data-v-9dada9bc offset="0" stop-color="#868CFF"></stop>
              <stop data-v-9dada9bc offset="1" stop-color="#546FFF"></stop>
            </linearGradient>
            <mask data-v-9dada9bc id="mask-54_12002" maskUnits="userSpaceOnUse" style="mask-type: alpha;">
              <path data-v-9dada9bc fill="#546FFF" d="M68 9L331 9C353.091 9 371 26.9086 371 49L371 94C371 116.091 353.091 134 331 134L68 134C45.9086 134 28 116.091 28 94L28 49C28 26.9086 45.9086 9 68 9Z" style="mix-blend-mode: normal;"></path>
            </mask>
            <linearGradient data-v-9dada9bc id="linear_fill_54_12003" x1="303.9541015625" y1="-69.779541015625" x2="273.872802734375" y2="156.2249755859375" gradientUnits="userSpaceOnUse">
              <stop data-v-9dada9bc offset="0" stop-color="#FFFFFF"></stop>
              <stop data-v-9dada9bc offset="0.01" stop-color="#FFFFFF"></stop>
              <stop data-v-9dada9bc offset="1" stop-color="#FFFFFF" stop-opacity="0"></stop>
            </linearGradient>
            <filter data-v-9dada9bc id="filter_54_12010" x="0" y="0" width="399" height="169" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
              <feFlood data-v-9dada9bc flood-opacity="0" result="feFloodId_54_12010"></feFlood>
              <feColorMatrix data-v-9dada9bc in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha_54_12010"></feColorMatrix>
              <feOffset data-v-9dada9bc dx="0" dy="18"></feOffset>
              <feGaussianBlur data-v-9dada9bc stdDeviation="20"></feGaussianBlur>
              <feComposite data-v-9dada9bc in2="hardAlpha_54_12010" operator="out"></feComposite>
              <feColorMatrix data-v-9dada9bc type="matrix" values="0 0 0 0 0.4392156862745098 0 0 0 0 0.5647058823529412 0 0 0 0 0.6901960784313725 0 0 0 0.12 0"></feColorMatrix>
              <feBlend data-v-9dada9bc mode="normal" in2="feFloodId_54_12010" result="dropShadow_1_54_12010"></feBlend>
              <feBlend data-v-9dada9bc mode="normal" in="SourceGraphic" in2="dropShadow_1_54_12010" result="shape_54_12010"></feBlend>
            </filter>
          </defs>
        </svg>
        <!-- 数据绑定部分 -->
        <div class="item-1-text">{{ totalCorporateCount }}</div>
      </div>
    </div>
 
   <!-- 从业人员期末人数卡片 -->
    <div class="item-box personnel-box" cid="ItemBox">
      <div class="head">
        <span>从业人员期末人数</span>
        <span class="total-badge">{{ (totalPersonnel / 10000).toFixed(2) }} 万人</span>
      </div>
      <div class="content flex-content">
        <div ref="personnelChartRef" class="chart-container"></div>
      </div>
    </div>
 
    <!-- 营业收入卡片 -->
    <div class="item-box revenue-box" cid="ItemBox">
      <div class="head">
        <span>营业收入</span>
        <span class="total-badge">{{ (totalEconomic / 10000).toFixed(2) }} 万元</span>
      </div>
      <div class="content flex-content">
        <div ref="revenueChartRef" class="chart-container"></div>
      </div>
    </div>
  </div>
</template>
 
<script setup lang="ts">
import * as echarts from 'echarts';
import { ref, watch, onMounted } from 'vue';

const props = defineProps({
  summaryData: { type: Object, default: () => ({}) }
});

const personnelChartRef = ref<HTMLElement | null>(null);
const revenueChartRef = ref<HTMLElement | null>(null);
let chart1: echarts.ECharts | null = null;
let chart2: echarts.ECharts | null = null;

const totalCorporateCount = ref(0);
const totalPersonnel = ref(0);
const totalEconomic = ref(0);

const colorMap: any = {
  "大型": "#57defd",
  "中型": "#b3e34b",
  "小型": "#ffb570",
  "微型": "#ee6666",
  "未知": "#8088ff"
};

const getCommonOption = () => ({
  legend: {
    orient: 'vertical',
    right: '5%',   
    top: 'center',
    itemWidth: 12,
    itemHeight: 12,
    itemGap: 25,
    textStyle: { color: '#666', fontSize: 16 }
  },
  tooltip: {
    trigger: 'item',
    backgroundColor: 'rgba(50, 50, 50, 0.8)',
    borderWidth: 0,
    textStyle: { color: 'white' ,fontSize: 16},
    formatter: (p: any) => `<span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;background-color:${p.color};"></span>${p.name}: ${p.value}`
  },
  series: [{
    type: 'pie',
    radius: ['65%', '90%'],
    center: ['40%', '50%'], 
    avoidLabelOverlap: false,
    itemStyle: { borderRadius: 0, borderColor: '#f5f5f5', borderWidth: 8 },
    label: { show: false, position: 'center', formatter: '{b}', fontSize: 36, fontWeight: 'bold' },
    emphasis: {
      scale:true,
      scaleSize: 20,
      label: { show: true, fontSize: 36, fontWeight: 'bold', color: 'inherit' }
    },
    data: []
  }]
});

const processData = () => {
  const res = props.summaryData;
  if (!res || Object.keys(res).length === 0) return;

  // --- 处理法人单位数量 ---
  totalCorporateCount.value = res.legalPersonNum || 0;

  // --- 处理从业人员图表 ---
  if (res.employmentPersonnel && Array.isArray(res.employmentPersonnel)) {
    const pData = res.employmentPersonnel.map((item: any) => ({
      name: item.name,
      value: (Number(item.value) / 10000).toFixed(2), 
      itemStyle: { color: colorMap[item.name] || '#ccc' }
    }));
    totalPersonnel.value = res.employmentPersonnel.reduce((acc: number, cur: any) => acc + Number(cur.value), 0);
    chart1?.setOption({ series: [{ data: pData }] });
  }

  // --- 处理营业收入图表 ---
  if (res.operatingIncome && Array.isArray(res.operatingIncome)) {
    const eData = res.operatingIncome.map((item: any) => ({
      name: item.name,
      value: (Number(item.value) / 10000).toFixed(2), 
      itemStyle: { color: colorMap[item.name] || '#ccc' }
    }));
    totalEconomic.value = res.operatingIncome.reduce((acc: number, cur: any) => acc + Number(cur.value), 0);
    chart2?.setOption({ series: [{ data: eData }] });
  }
};


const handleResize = () => {
  chart1?.resize();
  chart2?.resize();
};

// 初始化图表
onMounted(() => {
  if (personnelChartRef.value) {
    chart1 = echarts.init(personnelChartRef.value);
    chart1.setOption(getCommonOption());
  }
  if (revenueChartRef.value) {
    chart2 = echarts.init(revenueChartRef.value);
    chart2.setOption(getCommonOption());
  }
  processData();
  
  window.addEventListener('resize', handleResize);
});

// 在销毁时彻底清理
onUnmounted(() => {
  window.removeEventListener('resize', handleResize);
  
  if (chart1) {
    chart1.dispose();
    chart1 = null;
  }
  if (chart2) {
    chart2.dispose();
    chart2 = null;
  }
});

watch(() => props.summaryData, () => {
  processData();
}, { deep: true });
</script>

<style scoped>
.left {
width: 100%;
height: 100%;
background-color: white;
padding: 10px;
border-radius: 6px;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
display: flex;
flex-direction: column;
gap: 10px;
flex-shrink: 0;
}

.item-box {
background-color: white;
border-radius: 4px;
overflow: hidden;
display: flex;
flex-direction: column;
}

.head {
  display: flex;
  justify-content: space-between; 
  align-items: center;
  font-size: 18px;       
  font-weight: bold;     
  color: #333333;
  padding: 12px 16px;
}

.total-badge {
  font-size: 16px;       
  font-weight: normal;    
  background-color: #f5f5f5; 
  padding: 4px 12px;      
  border-radius: 20px;   
  margin-left: 10px;      
}

.content {
flex: 1;
position: relative;
padding: 0px 10px 10px 10px;
}

.corporate-box .content {
padding: 0;
height: 100px;
}

.item-1-text {
position: absolute;
left: 20px;
top: 42px;
font-size: 44px;
font-weight: bold;
color: white;
text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
z-index: 2;
}

.personnel-box,
.revenue-box {
flex: 1 1 0%;
}

.personnel-box .content,
.revenue-box .content {
padding: 0;
height: 100%;
}

.chart-container {
width: 100%;
height: 100%;
min-height: 180px;
}
</style>